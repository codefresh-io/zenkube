<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Deployment Browser</title>
    <script src="https://unpkg.com/lodash@4.17.4/lodash.js"></script>
    <script src="https://unpkg.com/kefir@3.7.4/dist/kefir.js"></script>
    <script src="https://unpkg.com/preact@8.2.6/dist/preact.js"></script>
    <link rel="stylesheet" href="css/main.css"/>

</head>
<body>
    <main></main>
    <script>

        let
            uiBus = Kefir.pool(),
            sendUiMessage = _.flow(Kefir.constant, uiBus.plug.bind(uiBus));

        let deploymentsProperty = Kefir
            .fromPromise(fetch('/logs').then((res)=> res.json()))
            .map(_.flow(_.reverse, _.partial(_.groupBy, _, 'id')))
            .toProperty(()=> []);

        let selectedDeploymentVersionsProperty = uiBus
            .filter(_.matches({ type: "select_version" }))
            .map(({ deploymentId, versionIndex })=>({ [deploymentId]: versionIndex }))
            .scan(_.merge, {});

        // GUI Cycle
        Kefir
            .combine([deploymentsProperty, selectedDeploymentVersionsProperty])
            .onValue((function(){

                const toPreactYAML = (function(){
                    const formatters = [
                        { test: (obj)=> ["number", "string"].some((typeName)=> typeof(obj) === typeName), format: (obj)=> preact.h('span', { class: "value" }, JSON.stringify(obj)) },
                        { test: (obj)=> obj === null, format: ()=> preact.h('span', { class: "value" }, "~") },
                        { test: _.isEmpty, format: ()=> preact.h('span', { class: "value" }, "{}") },
                        {
                            test: ()=> true,
                            format: (obj)=> {
                                return preact.h('div', {}, Object
                                    .keys(obj)
                                    .map((keyName)=> {
                                        let value = obj[keyName];
                                        return preact.h('div', {}, [
                                            Array.isArray(obj) ? preact.h('span', { class: "value" }, "- ") : [preact.h('span', { "class": "key" }, [keyName]), preact.h('span', { "class": "value"}, [": "])],
                                            toPreactYAML(value)
                                        ]);
                                    })
                                );
                            }
                        }
                    ];

                    return (obj)=> formatters.find(({ test })=> test(obj))["format"](obj);
                })();

                const
                    [ main, div, h1, span, select, option, code ] = ["main", "div", "h1", "span", "select", "option", "code"].map((name)=> _.partial(preact.h, name)),
                    { render } = preact,
                    isActive = _.flow(_.first, _.property('type'), _.partial(_.negate(_.isEqual), 'DELETED')),
                    getDocument = ( specVersion, docs )=> toPreactYAML(_.get(docs, `${_.clamp(specVersion, 0, docs.length)}.spec`)),
                    anchorBody = document.querySelector('body'),
                    anchorMain = document.querySelector('main');

                return ([deployments, selectedDeploymentVersions])=> {
                    render(
                        main(
                            {},
                            _.map(deployments, (versions, deploymentId)=> div(
                                { class: _.compact(["deployment", isActive(versions) && "active"]).join(' ') },
                                [
                                    h1({}, deploymentId),
                                    select({ onChange: ({ target: { selectedIndex } })=> sendUiMessage({ type: "select_version", deploymentId, versionIndex: selectedIndex }) }, versions.map(({ type }, version)=> option({ class: _.compact([type === "DELETED" && "deleted"]).join('') }, `Revision #${ versions.length - version }`))),
                                    code({ disabled: true }, getDocument(selectedDeploymentVersions[deploymentId] || 0, versions))
                                ]
                            ))
                        ), anchorBody, anchorMain
                    )
                };
            })());

    </script>
</body>
</html>