<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Deployments List</title>
    <link rel="stylesheet" href="css/flat_list.css"/>
    <link rel="stylesheet" href="https://unpkg.com/diff2html@2.3.2/dist/diff2html.min.css"/>
    <script src="https://unpkg.com/lodash@4.17.4/lodash.js"></script>
    <script src="https://unpkg.com/kefir@3.7.4/dist/kefir.js"></script>
    <script src="https://unpkg.com/react@16.0.0/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16.0.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/imurmurhash@0.1.4/imurmurhash.min.js"></script>
    <script src="https://unpkg.com/moment@2.19.1/min/moment.min.js"></script>
    <script src="https://unpkg.com/diff2html@2.3.2/dist/diff2html.min.js"></script>
</head>
<body>

    <main></main>
    <script>

        const
            VISUAL_BUFFER_SIZE = 5000,
            MAIN_PAGE_DEPLOYMENT_LIST = "deployment-list",
            MAIN_PAGE_DEPLOYMENT_REVISION_VIEW = "deployment-revision-view";

        let ui = (function(){
            let emitter = _.noop;
            return {
                stream: Kefir.stream(({ emit })=> emitter = emit),
                send: (message)=> emitter(message)
            };
        })();

        let focusChangeStream = ui.stream
            .filter(_.matches({ type: "focus-deployment-revision" }))
            .map(({ id, hash })=> ({
                "main_page": MAIN_PAGE_DEPLOYMENT_REVISION_VIEW,
                "focused_deployment_id": id,
                "focused_deployment_revision": hash
            }));

        let backStream = ui.stream.filter(_.matches({ type: "back" })).map(_.constant({ "main_page": MAIN_PAGE_DEPLOYMENT_LIST }));

        let uiStateProperty = Kefir.merge([
                focusChangeStream,
                backStream
            ])
            .scan(_.merge, {
                "main_page": MAIN_PAGE_DEPLOYMENT_LIST,
                "focused_deployment_id": undefined,
                "focused_deployment_revision": undefined
            })
            .toProperty();

        let rawStream = Kefir
            .fromPromise(fetch('log').then((res)=> res.text()).then(_.partial(_.split, _, '\n')))
            .flatten()
            .map(_.partial(_.attempt, JSON.parse))
            .filter(_.negate(_.isError));

        let deploymentsProperty = rawStream
            .slidingWindow(VISUAL_BUFFER_SIZE)
            .debounce()
            .map(_.partial(_.sortBy, _, 'timestamp'))
            .map((buffer)=> {
                return _(buffer)
                    .chain()
                    .groupBy('event.object.metadata.uid')
                    .map((events, id)=>({
                        id,
                        create: _.flow(_.first, _.property('event.object.metadata.creationTimestamp'), (utcStr)=> new Date(utcStr))(events),
                        name: _.flow(_.first, _.property('event.object.metadata.name'))(events),
                        revision: _(events)
                            .map(({ timestamp, event: { object: { spec } } })=>({
                                create: new Date(timestamp),
                                hash: MurmurHash3(JSON.stringify(spec)).result(),
                                spec
                            }))
                            .uniqBy('hash')
                            .value(),
                        online: _(events).chain().reverse().map(_.flow(_.property('event.object.status.conditions'), _.partial(_.find, _, { type: "Available" }))).first().thru(({ status } = {})=> status === "True").value(),
                        destroy: _(events).chain().find({ event: { type: "DELETED" }}).get('timestamp').thru((utcStr)=> utcStr && new Date(utcStr)).value(),
                        snapshot: _(events).chain().filter(_.matchesProperty('event.object.metadata.uid', id)).map('event.object.status').flatten().value()
                    }))
                    .value();
            })
            .toProperty(_.constant([]));

        let domReadyProperty = Kefir
            .fromEvents(window, 'DOMContentLoaded')
            .take(1)
            .map(()=> document.querySelector('body'))
            .toProperty();

        // UI Cycle
        Kefir
            .combine([
                uiStateProperty,
                deploymentsProperty,
                domReadyProperty
            ])
            .onValue((function(){

                const [header, ul, li, main, div, time, img, span, a, code, select, option, button, i] = ["header", "ul", "li", "main", "div", "time", "img", "span", "a", "code", "select", "option", "button", "i"].map((name)=> _.partial(React.createElement, name));

                const deploymentName = (deployment, onClick = _.noop)=> span({ onClick, className: _.compact(["deployment-name", deployment["destroy"] && "inactive"]).join(' ') }, deployment["name"]);

                const toReactYAML = (function(){
                    const formatters = [
                        { test: (obj)=> ["number", "string"].some((typeName)=> typeof(obj) === typeName), format: (obj)=> span({ className: "value" }, [], JSON.stringify(obj)) },
                        { test: (obj)=> obj === null, format: ()=> span({ className: "value" }, [], "~") },
                        { test: _.isEmpty, format: ()=> span({ className: "value" }, [], "{}") },
                        {
                            test: ()=> true,
                            format: (obj)=> {
                                return div({}, [], ...Object
                                    .keys(obj)
                                    .map((keyName)=> {
                                        let value = obj[keyName];
                                        return div({}, [], ..._.flatten([
                                            Array.isArray(obj) ? span({ className: "value" }, [], "- ") : [span({ className: "key" }, [], keyName), span({ className: "value"}, [], ": ")],
                                            toReactYAML(value)
                                        ]));
                                    })
                                );
                            }
                        }
                    ];

                    return (obj)=> formatters.find(({ test })=> test(obj))["format"](obj);
                })();

                const pageHeader = (function(dictionary){
                    return (uiState, deployments)=>
                        header(
                            { key: "header" }, [],
                            ..._.compact([(dictionary[uiState["main_page"]] || _.constant("N/A"))(uiState, deployments),
                            uiState["main_page"] !== MAIN_PAGE_DEPLOYMENT_LIST && button({ onClick: ()=> ui.send({ type: "back" }) }, ["Back"])])
                        )
                })({
                    [MAIN_PAGE_DEPLOYMENT_LIST]: _.constant("Deployments Activity"),
                    [MAIN_PAGE_DEPLOYMENT_REVISION_VIEW]: ({ focused_deployment_revision: r, focused_deployment_id: id }, deployments)=> ["Revision ", r.toString(16), " of deployment ", deploymentName(_(deployments).find({ id }))]
                });

                const deploymentListPage = (uiState, deployments)=>
                    main(
                        { className: "deployment-list" },
                        ul(
                            {},
                            _(deployments)
                                .map(({ id, name, revision, destroy, online })=> revision.map((rev)=> _.assign({ id, name, destroy, online }, rev)))
                                .flatten()
                                .value()
                                .map(({ id, create, hash, name, destroy, online })=> li(
                                        { key: [id, hash].join('-') }, [],
                                        div({ className: "deployment" }, [],
                                            img({ src: `https://robohash.org/${id}.png?size=32x32` }),
                                            div({ className: "name" }, [],
                                                i({ title: online ? "Last status was OK" : "Last status failed or not available", className: _.compact(["deployment-status", online && "online"]).join(' ') }),
                                                deploymentName({ name, destroy }),
                                                " was committed a new change " ,
                                                a({ onClick: ()=> ui.send({ type: "focus-deployment-revision", id, hash }) }, ["#", hash.toString(16)])
                                            ),
                                            time({}, moment(create).fromNow())
                                        )
                                    )
                                )
                        )
                    );

                const deploymentRevisionPage = ({ focused_deployment_id: id, focused_deployment_revision: revision }, deployments)=> {
                    let currentRevision = _(deployments).chain().find({ id }).get('revision').find({ hash: revision }).value();
                    return main(
                        { className: "focus-deployment-revision" }, [],
                        header({}, [],
                            "Revision ",
                            select(
                                {
                                    value: revision,
                                    onChange: (e)=> ui.send({ type: "focus-deployment-revision", id, hash: +e.target.value })
                                },
                                _(deployments).chain().find({ id }).get('revision', []).map(({ hash })=> option({ value: hash }, hash.toString(16))).value()
                            ),
                            time({ className: "captured" }, ` from event captured ${moment(currentRevision["create"]).fromNow()}`)
                        ),
                        code({}, [], toReactYAML(_(currentRevision).chain().get('spec').value()))
                    );
                };

                const mainView = function(uiState, deployments){
                    return [
                        pageHeader(uiState, deployments),
                        {
                            [MAIN_PAGE_DEPLOYMENT_LIST]: deploymentListPage,
                            [MAIN_PAGE_DEPLOYMENT_REVISION_VIEW]: deploymentRevisionPage
                        }[uiState["main_page"]](uiState, deployments)
                    ];
                };

                return function([uiState, deployments = [], mainElement]){
                    return ReactDOM.render(mainView(uiState, deployments), mainElement);
                }
            })());

    </script>
</body>
</html>